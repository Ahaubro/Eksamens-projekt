<h1>Smile Posts</h1>

<div id="postsPos">
    <div id="posts">
    </div>

</div>



<script>

    setActive()
    function setActive() {

        const currentPage = window.location.pathname.substring(1)
        let aTags = document.getElementsByTagName('a')
        for (let i = 0; i < 4; i++) {
            if (aTags[i].className === "active") {
                aTags[i].id === aTags[i].className
            }
        }
        document.getElementById(currentPage).className = "active"
    }


    const postsDiv = document.getElementById("posts");
    let posts;

    loadPosts();

    async function loadPosts() {
        const response = await fetch("/api/posts");
        const result = await response.json();
        posts = result;
        postsDiv.innerHTML = "";

        const likedResponse = await fetch(`/api/likedPosts/`);
        const likedResult = await likedResponse.json();
        likedPosts = likedResult
        console.log(likedPosts)

        for (let i in posts) {
            const { id, text, userId, date, hours, minutes, categori } = posts[i];

            if (categori != 'home') {
                const likes = posts[i].likes || 0;
                const hearts = posts[i].hearts || 0;
                const cares = posts[i].cares || 0;
                const resObj = await fetch(`/api/getUserById/${userId}`);
                const foundUser = await resObj.json();
                
                const like = "like";
                const heart = "heart"
                const care = "care"

                postsDiv.innerHTML += ` <br> 
                            <article class="postArticle">
                                <b id="username">${foundUser.username} - ${categori} post</b>
                                <br>
                                <span id="text${id}">${text}</span>
                                <br>
                                <br>
                                <b id="date"> ${date} </b> <b id="time"> ${hours}:${minutes}</b>
                                <br`

                if (likedPosts.find((post) => post.postId == id)) {
                    postsDiv.innerHTML += `
                    <span id="likeCount${id}">${likes}</span> <span>Remove like</span> <div id="likeButton${id}"><button data-reaction="like" onclick="unlikePost(${id}, 'likes')">Unlike</button>
                    <span id="likeCount${id}">${hearts}</span> <span>Remove heart</span> <div id="likeButton${id}"><button data-reaction="heart" onclick="unlikePost(${id}, 'hearts')">Unlike</button>    
                    <span id="likeCount${id}">${cares}</span> <span>Remove care</span> <div id="likeButton${id}"><button data-reaction="care" onclick="unlikePost(${id}, 'cares')">Unlike</button>
                    </div>`

                } else {
                    console.log(like + " " + care + " " + " " + heart)
                    postsDiv.innerHTML += `
                    <span id="likeCount${id}">${likes}</span> <span>üòç</span> <div id="likeButton${id}"><button data-reaction="like" onclick="likePost(${id}, 'likes')">üòç</button>
                    <span id="heartCount${id}">${hearts}</span> <span>‚ù§Ô∏è</span> <div id="heartButton${id}"><button data-reaction="heart" onclick="likePost(${id}, 'hearts')">‚ù§Ô∏è</button>
                    <span id="careCount${id}">${cares}</span> <span>ü•∞</span> <div id="careButton${id}"><button data-reaction="care" onclick="likePost(${id}, 'cares')">ü•∞</button>
                                </div>`;
                }
                postsDiv.innerHTML += `</article> 
                            <br>`

            }
        }
    }

    async function likePost(id, reaction) {
        // let likeCountElement = document.getElementById("likeCount" + id);
        // let heartCountElement = document.getElementById("heartCount" + id);
        // let careCountElement = document.getElementById("careCount" + id);

        // let likeCount = Number(likeCountElement.innerText);
        // let heartCount = Number(heartCountElement.innerText);
        // let careCount = Number(careCountElement.innerText);

        // likeCountElement.innerText = ++likeCount;
        // heartCountElement.innerText = ++likeCount;
        // careCountElement.innerText = ++likeCount;

        // let likeButtonDiv = document.getElementById("likeButton" + id + reaction);
        // let heartButtonDiv = document.getElementById("heartButton" + id + reaction);
        // let careButtonDiv = document.getElementById("careButton" + id + reaction);

        // likeButtonDiv.innerHTML = "";
        // heartButtonDiv.innerHTML = "";
        // careButtonDiv.innerHTML = "";



        console.log("HALO HALLLo")
        // const reaction = document.querySelector("data-reaction")
        // console.log(reaction)
        const response = await fetch(`/api/postsOnlyLikes/${id}`, {
            headers: {
                "content-type": "application/json",
            },
            method: "PUT",
            body: JSON.stringify({ reaction })
        });

        loadPosts();
    }

    async function unlikePost(id, reaction) {
        console.log(reaction)
        const response = await fetch(`/api/postsOnlyUnLikes/${id}`, {
            headers: {
                "content-type": "application/json",
            },
            method: "PUT",
            body: JSON.stringify({ reaction })
        });

        const deleteResponse = await fetch(`/api/unlike/` + id, {
            method: "DELETE",
        });

        loadPosts();
    }

    async function checkLikedPosts() {
        const res = await fetch(`/api/likedPosts`);
    }

</script>
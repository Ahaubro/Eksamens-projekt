<h1>Smile Posts</h1>

<div id="postsPos">
    <div id="posts">
    </div>

</div>

<div id="postsPos">
    <input id="createText" type="text" width="400">
    <button onclick="createPost()">Create New Post</button>
</div>

<p id="response"></p>


<script>

    setActive()
    function setActive(){

        const currentPage = window.location.pathname.substring(1)
        let aTags = document.getElementsByTagName('a')
        for (let i = 0; i < 4; i++) {
            if(aTags[i].className === "active"){
                aTags[i].id === aTags[i].className
            }   
        }
        document.getElementById(currentPage).className = "active"
    }


    const postsDiv = document.getElementById("posts");
    let posts;

    loadPosts();

    async function loadPosts(){
        const response = await fetch("/api/posts");
        const result = await response.json();
        posts = result;
        postsDiv.innerHTML = ""; 
        for(let i in posts){
            console.log(posts)
            const {id, text, userId, date, hours, minutes} = posts[i];

            const resObj = await fetch(`/getUserById/${userId}`);
            const foundUser = await resObj.json();
           
            postsDiv.innerHTML += ` <br> 
                <article class="postArticle">
                    <b id="username">${foundUser.username}</b>
                    <br>
                    <div id="edit${id}">
                        <span id="text${id}">${text}</span>
                        <button onclick="openEdit(${id})"> Edit </button>
                    </div>
                    <br>
                    <br>
                    <b id="date"> ${date} </b> <b id="time"> ${hours}:${minutes}</b>
                    <br>
                </article> 
                <button onclick="deletePost(${id})"> Delete </button>
                <br>`;
            
        }
    }

    async function createPost(){
        const text = document.getElementById("createText").value;
        const response = await fetch("/api/posts", {
            headers: {
                "content-type": "application/json",
            },
            method: "POST",
            body: `{"text": "${text}"}`
        });
        const result = await response.json();
        loadPosts();
    }

    function openEdit(id){
        const element = document.getElementById("edit" + id);
        const text = document.getElementById("text" + id).innerText;
        element.innerHTML = `<div id="edit${id}">
                    <input id="input${id}" value="${text}">
                    <button onclick="editPost(${id})">Save</button>
                </div>`;
    }

    async function editPost(id){
        let resMessage = "";

        const firstResponse = await fetch(`/api/getPostByID/${id}`);
        const firstResult = await firstResponse.json();
        const post = firstResult;
        const userId = post.userId

        const text = document.getElementById("input" + id).value;
        const response = await fetch(`/api/posts/` + id, {
            headers: {
                "content-type": "application/json",
            },
            method: "PUT",
            body: JSON.stringify({text, userId})
        });
        //const result = await response.json();
        resMessage = await response.text();
        document.getElementById("response").innerText=resMessage
        //console.log(result);
        
        loadPosts();
    }



    async function deletePost(id){
        let resMessage = "";

        const firstResponse = await fetch(`/api/getPostByID/${id}`);
        const firstResult = await firstResponse.json();
        const post = firstResult;
        const userId = post.userId

        const response = await fetch(`/api/posts/${id}/${userId}`, {
            method: "DELETE",
        });
        
        resMessage = await response.text();
        document.getElementById("response").innerText=resMessage

        loadPosts();
    }

</script>
<h1>Smile Posts</h1>

<div id="postsPos">
    <div id="posts">
    </div>

</div>



<script>

    setActive()
    function setActive() {

        const currentPage = window.location.pathname.substring(1)
        let aTags = document.getElementsByTagName('a')
        for (let i = 0; i < 4; i++) {
            if (aTags[i].className === "active") {
                aTags[i].id === aTags[i].className
            }
        }
        document.getElementById(currentPage).className = "active"
    }


    const postsDiv = document.getElementById("posts");
    let posts;

    loadPosts();

    async function loadPosts() {
        const response = await fetch("/api/posts");
        const result = await response.json();
        posts = result;
        postsDiv.innerHTML = "";

        const likedResponse = await fetch(`/api/likedPosts/`);
        const likedResult = await likedResponse.json();
        likedPosts = likedResult



        for (let i in posts) {
            const { id, text, userId, date, categori } = posts[i];
            let {minutes, hours } = posts[i];
            const reverseDate = date.split("-").reverse().join("-")

            minutes = formatTime(minutes);
            hours = formatTime(hours);

            if (categori != 'home') {
                const likes = posts[i].likes || 0;
                const hearts = posts[i].hearts || 0;
                const cares = posts[i].cares || 0;
                const resObj = await fetch(`/api/getUserById/${userId}`);
                const foundUser = await resObj.json();
                let SecondPostPart = ""
                const firstPostPart = `
                    <br> 
                        <div class="post-div">
                        <b id="username">${foundUser.username} - ${categori} post</b>
                        <br>
                        <span id="text${id}">${text}</span>
                        <br>
                        <br>
                        <div id="info-and-reaction">
                        <b id="date"> ${reverseDate} </b> `

                // if (likedPosts.find((post) => post.postId == id && post.reaction === 0)) {
                //     SecondPostPart += ` 
                //         <div id="reaction-count">
                //             <div id="like-count"> <button id="like-button" onclick="unaddReaction(${id}, 'likes')">üòç</button> <div id="remove-like" onclick="unaddReaction(${id}, 'likes')" >X</div>  <b id="likeCount${id}">${likes}</b> </div>
                //             <div id="heart-count"> <span id="heart-button" onclick="unaddReaction(${id}, 'hearts') disabled">‚ù§Ô∏è</button> <b id="heartCount${id}">${hearts}</b>  </div> 
                //             <div id="care-count"> <button id="care-button" onclick="unaddReaction(${id}, 'cares')" disabled>ü•∞</button> <b id="careCount${id}">${cares}</b> </div> 
                //         </div>`
                // } else if (likedPosts.find((post) => post.postId == id && post.reaction === 1)) {
                //     SecondPostPart += `
                //         <div id="reaction-count">
                //             <div id="like-count"> <button id="like-button" onclick="unaddReaction(${id}, 'likes') disabled">üòç</button> <b id="likeCount${id}">${likes}</b> </div>
                //             <div id="heart-count"> <button id="heart-button" onclick="unaddReaction(${id}, 'hearts')">‚ù§Ô∏è</button> <div id="remove-heart" onclick="unaddReaction(${id}, 'hearts')" >X</div>  <b id="heartCount${id}">${hearts}</b>  </div> 
                //             <div id="care-count"> <button id="care-button" onclick="unaddReaction(${id}, 'cares') disabled">ü•∞</button> <b id="careCount${id}">${cares}</b> </div> 
                //         </div>`
                // } else if (likedPosts.find((post) => post.postId == id && post.reaction === 2)) {
                //     SecondPostPart += `
                //         <div id="reaction-count">
                //             <div id="like-count"> <button id="like-button" onclick="unaddReaction(${id}, 'likes') disabled">üòç</button> <b id="likeCount${id}">${likes}</b> </div>
                //             <div id="heart-count"> <button id="heart-button" onclick="unaddReaction(${id}, 'hearts') disabled">‚ù§Ô∏è</button> <b id="heartCount${id}">${hearts}</b>  </div> 
                //             <div id="care-count"> <button id="care-button" onclick="unaddReaction(${id}, 'cares')">ü•∞</button> <div id="remove-care" onclick="removeReaction(${id}, 'cares')" >X</div> <b id="careCount${id}">${cares}</b> </div> 
                //         </div>`
                // } else {
                    SecondPostPart += `
                        <div id="reaction-count">
                            <div id="like-count"> <div id="likeButton${id}"><button id="like-button" onclick="addReaction(${id}, 'likes', ${likes})">üòç</button></div>  <b id="likeCount${id}">${likes}</b> </div>
                            <div id="heart-count"> <div id="heartButton${id}"><button id="heart-button" onclick="addReaction(${id}, 'hearts', ${hearts})">‚ù§Ô∏è</button></div>  <b id="heartCount${id}">${hearts}</b>  </div> 
                            <div id="care-count"> <div id="careButton${id}"><button id="care-button" onclick="addReaction(${id}, 'cares', ${cares})">ü•∞</button></div>  <b id="careCount${id}">${cares}</b> </div> 
                        </div> `;
                //}
                const thirdPostPart = `<b id="time"> ${hours}:${minutes}</b>
                                        </div>
                                        <br>   
                                        </div>`

                postsDiv.innerHTML += firstPostPart + SecondPostPart + thirdPostPart;
            }
        }
    }
    //lav en metode som disabler de andre knapper n√•r man har liket en post. S√• skal hele postet ikke laves om og man sparer alle if statements. Brug likebutton{id} til at se om brugeren har liket posten, og hvis de har - disable 
    async function addReaction(id, reaction, likes) {

        const reactionArray = ['likes', 'hearts', 'cares']
        const reactionID = reactionArray.indexOf(reaction)
        const buttonIDs = ["likeButton", "heartButton", "careButton"]
        const butId = buttonIDs[reactionID]
        likes++
        for(let reactionButton in buttonIDs){
            document.getElementById(reactionButton+id).innerHTML = `
            <div id="like-count"> <div ${reactionButton+id}> <button id="like-button" onclick="removeReaction(${id}, 'likes', ${likes})">üòç</button> <div id="remove-like" onclick="removeReaction(${id}, 'likes', ${likes})" >X</div> </div>  <b id="likeCount${id}">${likes}</b> </div>
            `
            
        }


        const response = await fetch(`/api/postsOnlyLikes/${id}`, {
            headers: {
                "content-type": "application/json",
            },
            method: "PUT",
            body: JSON.stringify({ reaction })
        });
        



        loadPosts();
    }

    async function removeReaction(id, reaction) {
        console.log("unliked: ",reaction)
        const response = await fetch(`/api/postsOnlyUnLikes/${id}`, {
            headers: {
                "content-type": "application/json",
            },
            method: "PUT",
            body: JSON.stringify({ reaction })
        });

        const deleteResponse = await fetch(`/api/unlike/` + id, {
            method: "DELETE",
        });

        loadPosts();
    }

    async function checkLikedPosts() {
        const res = await fetch(`/api/likedPosts`);
    }

    function formatTime(time) {
    
        if ( time < 10 ) {

            return '0' + time;
        }

        return time;
    }


</script>
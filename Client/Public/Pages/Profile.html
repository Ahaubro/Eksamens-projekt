<span id="userid" style="display: none;">%%ID%%</span>
<h1 id="welcome"></h1>
<p>Here you see their smile posts and personal information</p>

<div id="myPage">
	<div id="profile_picture_div"></div>
    <br>
    <br>
    <br>
	<div id="profile-posts-pos">
		<div id="posts"></div>
	</div>
	<br>
	<br>
	<br>
	<div id="editBtnPos">
		<button id="editBtn" onclick="showInfoModal()"> Press here to see profile information</button>
	</div>
</div>


<button id="add_friend_btn" onclick="addFriend()"> Add friend</button>
<p id="responseMessage"></p>


<div id="friends_pos">
    <p>Friends:</p>
    <hr>
    <div id="friends"></div>
</div>



<div id="infoModal" class="hidden-modal">
	<h3>User information</h3>
	<hr>

	<label for="uname">Username</label>
	<span id="uname" type="text"></span>
	<br>
	<label for="fname">Firstname</label>
	<span id="fname" type="text"></span>
	<br>
	<label for="mname">Middlename</label>
	<span id="mname" type="text"></span>
	<br>
	<label for="lname">Lastname</label>
	<span id="lname" type="text"></span>
	<br>
	<label for="bday">Birthday</label>
	<span id="bday" type="date" value="2022-01-01"></span>
	<br>
	<label for="address">Address</label>
	<span id="address" type="text"></span>
	<br>
	<label for="country">Country</label>
	<div id="country"></div>
	<br>
	<label for="city">City</label>
	<span id="city" type="text"></span>
	<br>
	<label for="zip">Zipcode</label>
	<span id="zip" type="number"></span>
	<br>
	<label for="pcolor">Profile color</label>
	<div id="pcolor"></div>

	<label for="profilePic">Profile picture</label>
	<div id="display_image"></div>


	<div id="reponse"></div>
	<br>
    <div style="display: flex"></div>
	<button id="close-regmodal" onclick="hideInfoModal()" style="margin-left: 0; margin-right: auto">Close</button>

</div>

<script>
    const userId = document.getElementById("userid").innerText;

	const postsDiv = document.getElementById("posts");
    let posts;

    // Til friends
    let loadedUsername;

    loadPosts();

    async function loadPosts(){
        const response = await fetch("/api/posts/byUserId/"+userId);
        const result = await response.json();
        posts = result;
        postsDiv.innerHTML = ""; 
        for(let i in posts){
            console.log(posts)
            const {id, text, userId, date, hours, minutes} = posts[i];

            const resObj = await fetch(`/api/getUserById/${userId}`);
            const foundUser = await resObj.json();
           
            postsDiv.innerHTML += ` <br> 
            <article class="postArticle">
                <b id="username">${foundUser.username}</b>
                <br>
                <div>
                    <span id="text${id}">${text}</span>
                </div>
                <br>
                <br>
                <b id="date"> ${date} </b> <b id="time"> ${hours}:${minutes}</b>
                <br>
            </article> 
            <br>`;
        }
    }

    // MODAL

	function showInfoModal() {
        infoModal.className = 'shown-modal';
    }

    function hideInfoModal() {
        infoModal.className = 'hidden-modal';
    }

    document.addEventListener('mouseup', function(event) {
        if (!infoModal.contains(event.target))
            hideInfoModal();
    });

    responseMessage = "";
    getProfileInformation()
    async function getProfileInformation() {
        const res = await fetch("/api/getUserById/" + userId);
        const user = await res.json()

        loadedUsername = user.username

        uname.innerText = user.username
        fname.innerText = user.firstname
        mname.innerText = user.middlename
        lname.innerText = user.lastname
        bday.innerText = user.birthday
        address.innerText = user.address
        country.innerText = user.country
        city.innerText = user.city
        zip.innerText = user.zipcode
        pcolor.innerText = user.profilecolor

        document.getElementById("welcome").innerText = "Hello, welcome to " + user.username + "'s page";

        
        profile_picture_div.style.backgroundImage = `url('../Images/Uploads/${user.profilepicture}')`
        
        
    };

    async function addFriend() {
        const userTwoId = userId

        const res = await fetch(`/api/friends/`, {
            headers: {
                "content-type": "application/json",
            },
            method: "POST",
            body: `{"userTwoId": "${userTwoId}"}`
        })


        response = document.getElementById("responseMessage");
        response.innerText= await res.text();
    }

    async function getFriends() {
		const friendsDiv = document.getElementById("friends");
		let friendList;
		let users = [];
		let arr = [];
        let userNameList = [];

		const res = await fetch(`/api/profileFriends/${userId}`);
		const result = await res.json();

		friendList = result;

        console.log("NU FRIENDLIST", friendList)

		for(let friends in friendList) {
			const { userOne, userTwo } = friendList[friends];

			arr.push(userOne);
			arr.push(userTwo); 
		}

		for(let i in arr) {
			const userOneRes = await fetch(`/api/getUserById/${arr.at(i)}`)
			const userOneResult = await userOneRes.json();

			if(userOneResult.username != loadedUsername) {
                userNameList.push(userOneResult.username)
                console.log("Usernamelistr", userNameList)
            }
		}
        // Eventuelt udskift med filter funktion doh
        let uniqueList = [];
        userNameList.forEach((element) => {
            if (!uniqueList.includes(element)) {
                uniqueList.push(element);
            }
        });

        for(let i in uniqueList) {
            friendsDiv.innerHTML+=`<p> ${uniqueList[i]} </p>`;
        }
	}

    getFriends();

</script>

<div id="content">
    <h1>Chatrooms</h1>
    <div id="chatroomsList"></div>
    <input id="chatroomName"/>
    <button onclick="createChatroom()">Create</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

    //Set active function
    setActive();
    function setActive(){

        const currentPage = window.location.pathname.substring(1)
        
        let aTags = document.getElementsByTagName('a')
        for (let i = 0; i < 4; i++) {
            if(aTags[i].className === "active"){
                aTags[i].id === aTags[i].className
            }
        }

        document.getElementById(currentPage).className = "active"
    }

    // Chatrooms
    let currentRoomId = 0;

    const socket = io();
    socket.on("recieved-message", ({username, message, roomId}) => {
        if(currentRoomId == roomId) {
            messages.innerHTML+=`<p> ${username} <br> ${message} </p>`
        } 
    });
    
    function sendMessage(roomId) {

        const input = document.getElementById("messageInput").value;
        socket.emit("sent-message", {username: "Test", message: input, roomId});
    }

    let chatroomsDiv = document.getElementById("chatroomsList");
    let chatrooms;

    async function loadChatrooms(chatroomsDiv){

        const response = await fetch("/api/chatrooms");
        const result = await response.json();
        chatrooms = result;
        chatroomsDiv.innerHTML = "";
        for(let i in chatrooms){
            const {id, name} = chatrooms[i];
            chatroomsDiv.innerHTML+= `<p>
                <button onclick="joinRoom(${id}, '${name}')" id="chatroom${id}" class="chatroomBtns"> ${name} </button>
            </p>`;
        }
    }

    loadChatrooms(chatroomsDiv);
    const contentDiv = document.getElementById("content");

    function joinRoom(id, name) {
        console.log(id + name)

        currentRoomId = id;

        contentDiv.innerHTML= `
            <h1> ${name} </h1>
            <div id="messages"></div>

            <input placeholder="Message" id="messageInput">
            <button id="sendBtn" onclick="sendMessage(${id})">Send message</button>
            <button id="leaveBtn" onclick="leaveChatroom()">Leave chatroom</button>
        `;
    }

    function leaveChatroom() {
        currentRoomId = 0;
        contentDiv.innerHTML= ` 
            <h1>Chatrooms</h1>
            <div id="chatroomsList"></div>
            <input id="chatroomName"/>
            <button onclick="createChatroom()">Create</button>
        `;

        let chatroomsDiv = document.getElementById("chatroomsList");

        loadChatrooms(chatroomsDiv);
    }

    async function createChatroom(){
        let chatroomsDiv = document.getElementById("chatroomsList");
        const name = document.getElementById("chatroomName").value;
        const response = await fetch("/api/chatrooms", {
            headers: {"content-type": "application/json"},
            method: "POST",
            body: JSON.stringify({name})
        });
        loadChatrooms(chatroomsDiv);
    }

</script>

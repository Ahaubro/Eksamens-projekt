<div id="content">
    <h1>Chatrooms</h1>
    <div id="chatroomsList"></div>
    <input id="chatroomName"/>
    <button onclick="createChatroom()">Create</button>
</div>
<p id="response"></p>

<script src="/socket.io/socket.io.js"></script>
<script>

    //Set active function
    setActive();
    function setActive(){

        const currentPage = window.location.pathname.substring(1)
        
        let aTags = document.getElementsByTagName('a')
        for (let i = 0; i < 4; i++) {
            if(aTags[i].className === "active"){
                aTags[i].id === aTags[i].className
            }
        }

        document.getElementById(currentPage).className = "active"
    }

    // Chatrooms
    let currentRoomId = 0;

    async function loadMessages(){
        const response = await fetch("/api/chat_messages/"+currentRoomId);
        const oldMessages = await response.json();
        for(let i in oldMessages){
            const {username, message} = oldMessages[i];
            messages.innerHTML+=`<p><b>${username}:</b> ${message}</p>`;
        }
    }

    const socket = io();
    socket.on("recieved-message", ({username, message, roomId}) => {
        if(currentRoomId == roomId) {
            messages.innerHTML+=`<p><b>${username}:</b> ${message}</p>`;
        } 
    });

    async function sendMessage(roomId) {
        document.getElementById("response").innerText = "";
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value;
        if(message.length > 200)
            document.getElementById("response").innerText = "Message can not be over 200 characters";
        else{
            const response = await fetch("/api/chat_messages", {
                headers: {"content-type": "application/json"},
                method: "POST",
                body: JSON.stringify({message, roomId})
            });
            const username = await response.text();
            console.log(username);
            socket.emit("sent-message", {username, message, roomId});
            messageInput.value = "";
            updateMessageLength();
        }
    }

    function updateMessageLength(){
        let messageInput = document.getElementById("messageInput");
        let lengthLimit = document.getElementById("lengthLimit");
        let msgLength = document.getElementById("msgLength");
        msgLength.innerText = messageInput.value.length;
        if(messageInput.value.length > 200 && lengthLimit.style.color != "red")
            lengthLimit.style.color = "red";
        else if(messageInput.value.length <= 200 && lengthLimit.style.color != "black")
            lengthLimit.style.color = "black";
    }

    let chatroomsDiv = document.getElementById("chatroomsList");
    let chatrooms;

    async function loadChatrooms(chatroomsDiv){

        const response = await fetch("/api/chatrooms");
        const result = await response.json();
        chatrooms = result;
        chatroomsDiv.innerHTML = "";
        for(let i in chatrooms){
            const {id, name, username} = chatrooms[i];
            chatroomsDiv.innerHTML+= `<p>
                <button onclick="joinRoom(${id}, '${name}')" id="chatroom${id}" class="chatroomBtns"> <h2>${name}</h2><span>By ${username}<span></button>
            </p>`;
        }
    }

    loadChatrooms(chatroomsDiv);
    const contentDiv = document.getElementById("content");

    function joinRoom(id, name) {
        console.log(id + name)

        currentRoomId = id;

        contentDiv.innerHTML= `
            <h1> ${name} </h1>
            <div id="messages"></div>

            <input placeholder="Message" id="messageInput" onkeyup="updateMessageLength()"/>
            <span id="lengthLimit"><span id="msgLength">0</span>/200</span>
            <button id="sendBtn" onclick="sendMessage(${id})">Send message</button>
            <button id="leaveBtn" onclick="leaveChatroom()">Leave chatroom</button>
        `;

        loadMessages();
    }

    function leaveChatroom() {
        currentRoomId = 0;
        contentDiv.innerHTML= ` 
            <h1>Chatrooms</h1>
            <div id="chatroomsList"></div>
            <input id="chatroomName"/>
            <button onclick="createChatroom()">Create</button>
        `;

        let chatroomsDiv = document.getElementById("chatroomsList");

        loadChatrooms(chatroomsDiv);
    }

    async function createChatroom(){
        document.getElementById("response").innerText = "";
        let chatroomsDiv = document.getElementById("chatroomsList");
        const name = document.getElementById("chatroomName").value;
        const response = await fetch("/api/chatrooms", {
            headers: {"content-type": "application/json"},
            method: "POST",
            body: JSON.stringify({name})
        });
        const result = await response.text();
        document.getElementById("response").innerText = result;
        loadChatrooms(chatroomsDiv);
    }

</script>
